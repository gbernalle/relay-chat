<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <title>Chat Distribuído Pro</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #d9dbd5;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #app-container {
      width: 900px;
      height: 90vh;
      background: white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      display: flex;
      border-radius: 8px;
      overflow: hidden;
    }

    #login-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #009688;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }

    .login-box {
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-align: center;
      width: 350px;
    }

    .login-box input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .login-box button {
      width: 100%;
      padding: 10px;
      background: #009688;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      font-weight: bold;
      margin-top: 5px;
    }

    .login-box button:hover {
      background: #00796b;
    }

    #sidebar {
      width: 30%;
      background-color: #f0f0f0;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }

    .sidebar-header {
      padding: 20px;
      background-color: #ededed;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-list {
      overflow-y: auto;
      flex-grow: 1;
    }

    .user-item {
      padding: 15px 20px;
      border-bottom: 1px solid #f1f1f1;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
    }

    .user-item:hover {
      background-color: #e9e9e9;
    }

    .user-item.active {
      background-color: #ccebe8;
      border-left: 4px solid #009688;
    }

    .avatar {
      width: 40px;
      height: 40px;
      background-color: #ddd;
      border-radius: 50%;
      margin-right: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #555;
    }

    #chat-area {
      width: 70%;
      display: flex;
      flex-direction: column;
      background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
      background-color: #e5ddd5;
    }

    .chat-header {
      padding: 15px;
      background-color: #ededed;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      height: 60px;
    }

    .chat-placeholder {
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #888;
      flex-direction: column;
      background: #f0f0f0;
    }

    #messages {
      flex-grow: 1;
      padding: 20px;
      overflow-y: scroll;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .msg {
      padding: 8px 15px;
      border-radius: 8px;
      max-width: 70%;
      width: fit-content;
      position: relative;
      font-size: 0.9em;
      box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
    }

    .msg.sent {
      background-color: #dcf8c6;
      align-self: flex-end;
    }

    .msg.received {
      background-color: white;
      align-self: flex-start;
    }

    .msg-sender {
      font-size: 0.75em;
      color: #999;
      margin-bottom: 3px;
      display: block;
    }

    .input-area {
      padding: 15px;
      background-color: #f0f0f0;
      display: flex;
      gap: 10px;
    }

    .input-area input {
      flex-grow: 1;
      padding: 12px;
      border-radius: 20px;
      border: none;
      outline: none;
    }

    .input-area button {
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      background-color: #009688;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <div id="login-screen">
    <div class="login-box">
      <h2>Bem-vindo</h2>
      <p style="color: #666; margin-bottom: 20px; font-size: 0.9em;">Chat Distribuído</p>
      <input type="text" id="username" placeholder="Usuário">
      <input type="password" id="password" placeholder="Senha">
      <button onclick="login()">Entrar</button>
      <button onclick="register()" style="background-color: #7f8c8d; margin-top: 10px;">Criar Conta</button>
    </div>
  </div>

  <div id="app-container" style="display: none;">
    <div id="sidebar">
      <div class="sidebar-header">
        <div style="display: flex; align-items: center;">
          <div class="avatar" style="background: #009688; color: white;">Eu</div>
          <span id="display-username" style="font-weight: bold; margin-left: 10px;"></span>
        </div>
        <button onclick="logout()"
          style="border: none; background: transparent; color: red; cursor: pointer;">Sair</button>
      </div>
      <div id="users-list" class="user-list">
      </div>
    </div>

    <div id="chat-area">
      <div id="chat-header" class="chat-header" style="display: none;">
        <div class="avatar" id="chat-avatar">?</div>
        <span id="chat-title" style="font-weight: bold; margin-left: 10px;">Selecione um contato</span>
      </div>

      <div id="placeholder" class="chat-placeholder">
        <h3>Chat Distribuído</h3>
        <p>Selecione um usuário ao lado para conversar</p>
      </div>

      <div id="messages" style="display: none;"></div>

      <div id="input-box" class="input-area" style="display: none;">
        <input type="text" id="msg-input" placeholder="Digite uma mensagem...">
        <button onclick="sendMessage()">Enviar</button>
      </div>
    </div>
  </div>

  <script>
    const IP = "172.25.160.1";

    const AUTH_URL = `http://${IP}:8001`;
    const CHAT_URL = `http://${IP}:8002`;
    const WS_URL = `ws://${IP}:8002`;

    let currentUser = null;
    let currentRecipient = null;
    let ws = null;

    window.onload = function () {
      const savedUser = localStorage.getItem("chat_user");
      if (savedUser) {
        postLoginSetup(savedUser);
      }
    };

    async function login() {
      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;
      try {
        const res = await fetch(`${AUTH_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });
        if (res.ok) {
          const data = await res.json();
          localStorage.setItem("chat_user", data.username);
          postLoginSetup(data.username);
        } else alert("Login inválido");
      } catch (e) { alert("Erro ao conectar no Auth"); }
    }

    async function register() {
      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;
      try {
        await fetch(`${AUTH_URL}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });
        alert("Criado! Faça login.");
      } catch (e) { alert("Erro ao registrar"); }
    }

    function postLoginSetup(username) {
      currentUser = username;
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app-container').style.display = 'flex';
      document.getElementById('display-username').innerText = username;

      connectWS();
      loadUsersList();
    }

    function logout() {
      localStorage.clear();
      location.reload();
    }

    async function loadUsersList() {
      try {
        const res = await fetch(`${AUTH_URL}/users`);
        const users = await res.json();

        const listContainer = document.getElementById('users-list');
        listContainer.innerHTML = "";

        users.forEach(u => {
          if (u.username === currentUser) return;

          const div = document.createElement('div');
          div.className = 'user-item';
          div.id = `user-${u.username}`;
          div.onclick = () => selectUser(u.username);

          div.innerHTML = `
                        <div class="avatar">${u.username.substring(0, 2).toUpperCase()}</div>
                        <span>${u.username}</span>
                    `;
          listContainer.appendChild(div);
        });
      } catch (e) { console.error("Erro ao listar usuários", e); }
    }

    function selectUser(targetUser) {
      currentRecipient = targetUser;

      document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
      const activeEl = document.getElementById(`user-${targetUser}`);
      if (activeEl) activeEl.classList.add('active');

      document.getElementById('placeholder').style.display = 'none';
      document.getElementById('chat-header').style.display = 'flex';
      document.getElementById('messages').style.display = 'flex';
      document.getElementById('input-box').style.display = 'flex';

      document.getElementById('chat-title').innerText = targetUser;
      document.getElementById('chat-avatar').innerText = targetUser.substring(0, 2).toUpperCase();

      loadHistory();
    }

    async function loadHistory() {
      if (!currentRecipient) return;

      const msgBox = document.getElementById('messages');
      msgBox.innerHTML = '';

      try {
        const res = await fetch(`${CHAT_URL}/history/${currentUser}/${currentRecipient}`);
        const msgs = await res.json();
        msgs.forEach(m => {
          const isMe = (m.from === currentUser);
          displayMessage(m.from, m.content, isMe);
        });
      } catch (e) { console.error("Erro histórico", e); }
    }

    function displayMessage(sender, content, isMe) {
      const box = document.getElementById('messages');
      const el = document.createElement('div');
      el.className = `msg ${isMe ? 'sent' : 'received'}`;

      let senderTag = isMe ? '' : `<span class="msg-sender">${sender}</span>`;

      el.innerHTML = `${senderTag}${content}`;
      box.appendChild(el);
      box.scrollTop = box.scrollHeight;
    }

    function connectWS() {
      ws = new WebSocket(`${WS_URL}/ws/${currentUser}`);
      ws.onmessage = function (event) {
        const data = JSON.parse(event.data);

        if (data.from === currentRecipient || data.from === "eu") {
          displayMessage(data.from === "eu" ? "Você" : data.from, data.content, data.from === "eu");
        } else {
          alert(`Nova mensagem de ${data.from}`);
        }
      };
    }

    function sendMessage() {
      const txt = document.getElementById('msg-input').value;
      if (!ws || !currentRecipient || !txt) return;

      const payload = JSON.stringify({ to: currentRecipient, msg: txt });
      ws.send(payload);
      document.getElementById('msg-input').value = '';
    }

    document.getElementById("msg-input").addEventListener("keypress", function (event) {
      if (event.key === "Enter") sendMessage();
    });

  </script>
</body>

</html>